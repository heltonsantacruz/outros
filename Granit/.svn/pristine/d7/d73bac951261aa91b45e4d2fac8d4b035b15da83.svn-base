<%@page import="br.com.granit.persistencia.to.VendaTO"%>
<%@ taglib uri="http://displaytag.sf.net" prefix="display"%>
<%@ taglib uri="http://struts.apache.org/tags-html" prefix="html"%>
<%@ taglib uri="http://struts.apache.org/tags-bean" prefix="bean" %>
<%@ taglib uri="http://struts.apache.org/tags-logic" prefix="logic"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jstl/core"%>

<script language="javascript" src="<%=request.getContextPath() %>/js/mascarasReais.js"></script>
<script language="javascript" src="<%=request.getContextPath() %>/js/jsutil.js"></script>
<script language="javascript" src="<%=request.getContextPath() %>/js/trataValor.js"></script>
 
<div class="titulo">
	Informe os dados da Venda.
</div>
<jsp:include page="/WEB-INF/comum/mensagens.jsp" />

<logic:present name="forwardSecao">
	<script>
		var anchor = '${forwardSecao}';
	</script>		
</logic:present>
<logic:notPresent name="forwardSecao">
	<script>
		var anchor = '';
	</script>
</logic:notPresent>

<div class="conteudo">
<html:form action="/vendaAction.event?operacao=processarAlterar">
	<script type="text/javascript">

			function aplicaDesconto(desconto){
		   	 	action = '<html:rewrite page="/vendaAction.event?operacao=aplicaDescontoVendaPadraoAlterar"/>';
		        document.forms[0].action = action;
		        document.forms[0].submit();
		   	}    
    
            function adicionarItem() { 
                action = '<html:rewrite page="/vendaAction.event?operacao=adicionarItemAlterar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }

            function removerItem(posicao) {                
                action = '<html:rewrite page="/vendaAction.event?operacao=removerItemAlterar&posicao="/>' + posicao;
                document.forms[0].action = action;
                document.forms[0].submit();               
            }

            function adicionarItemBeneficiamentoAlterar() { 
                action = '<html:rewrite page="/vendaAction.event?operacao=adicionarItemBeneficiamentoAlterar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }

            function removerItemBeneficiamentoAlterar(posicao) {                
                action = '<html:rewrite page="/vendaAction.event?operacao=removerItemBeneficiamentoAlterar&posicao="/>' + posicao;
                document.forms[0].action = action;
                document.forms[0].submit();               
            }

            function alterar() { 
            	
                
                action = '<html:rewrite page="/vendaAction.event?operacao=processarAlterar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }
            
            function cancelar() { 
                action = '<html:rewrite page="/vendaAction.event?operacao=cancelar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }
            
            function finalizar() {
            	if(confirm('Deseja realmente finalizar a Venda?Caso confirme, não poderá mais alterar nada nessa venda!')){
	            	action = '<html:rewrite page="/vendaAction.event?operacao=processarAlterar&finalizar=true"/>';
	                document.forms[0].action = action;
	                document.forms[0].submit();               
            	}
            }   

            function atualizaTotalAPagar() { 
                action = '<html:rewrite page="/vendaAction.event?operacao=aplicaDescontoVendaAlterar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }  

            function marcarCheckbox(cb){
            	cb.checked = true;
            } 

            function atualizaTotalAPagarServicoMontagemAlterar() { 
                action = '<html:rewrite page="/vendaAction.event?operacao=aplicaValorServicoMontagemAlterar"/>';
                document.forms[0].action = action;
                document.forms[0].submit();               
            }    

            function goToAnchor() {
            	if (anchor != ''){
            		window.location.hash = anchor; 
            		var divMessages = document.getElementById('divMessages');
            		var divAnchor = document.getElementById(anchor + 'Message');
            		divAnchor.innerHTML = divMessages.innerHTML;
            		divMessages.innerHTML = '';
            	}
			}    
            
            function produtoEntregue(){
            	var entregue = document.forms[0].entregue.checked;
            	if(entregue){
            		if(!confirm('O produto realmente foi entregue? Caso confirme, a única operação permitida será a de Finalizar a venda!')){   
            			document.forms[0].entregue.checked = false;
            		}
            	}
            }
        </script>


<fieldset>
<%
	VendaTO venda = (VendaTO) request.getSession().getAttribute("vendaCliente");
%>
<legend>Dados da Venda:</legend>
<br>
	<div class="div_bloco">
		<label for="nome" class="form">Nº Pedido:</label>
       	<bean:write name="vendaCliente" property="numeroPedidoFormatado"/>
	</div>

	<div class="div_bloco">
		<label for="cliente" class="form">Cliente:</label>
<%if (venda.isProdutosEntregues()) { %>					
		<html:select property="idCliente" styleId="idCliente" disabled="true">
				<html:option value=""></html:option>
   				<html:optionsCollection name="listaClientesVendas" value="idPessoa" label="nome"/>	
		</html:select>	
<%}else{ %>
		<html:select property="idCliente" styleId="idCliente">
		<html:option value=""></html:option>
   				<html:optionsCollection name="listaClientesVendas" value="idPessoa" label="nome"/>	
		</html:select>	
<%} %>
								    		      	
	</div>	
	<div class="div_bloco">
		<label for="dataVenda" class="form">Data:</label>
       	<bean:write name="vendaCliente" property="dataVendaFormatada"/>	
	</div>
	<div class="div_bloco">
		<label for="data" class="form">Prazo de Entrega:</label>
<%if (venda.isProdutosEntregues()) { %>
        <html:text property="dataEntrega" size="10" readonly="true" disabled="true"/>
 <%}else{ %>
  		<html:text property="dataEntrega" size="10" maxlength="10" onblur="validaCampoData(this)" onkeypress="mascara(this,'99/99/9999');" 
        	onkeydown="if(event.keyCode == 13){event.cancelBubble = true; event.returnValue = false; return false;}"/>
 <%} %>
     </div>
</fieldset>

<a name="secaoItens"><br/></a>
<div id="secaoItensMessage" align="left"></div>
<%if (!venda.isProdutosEntregues()) { %>	
	<fieldset>
	<legend>Defina os itens para a Venda.</legend>
	<div class="div_bloco">
			<label for="itemVenda" class="form">
				Descrição do item:
			</label>       	
	       	<html:text property="descricaoItem" size="50" style="TEXT-TRANSFORM: uppercase;"/>    	  	
		</div> 		
		<div class="div_bloco">
			<label for="quantidade" class="form">
				Valor do Item (R$):
			</label> 	
			<html:text property="valorItem" onfocus="limpaCampo(this)"
					 size="15" maxlength="15" onkeypress="reaisLimitado(this,event,15)" onkeydown="backspace(this,event)"/>  	
		</div>
		
		<div class="div_bloco_1">
			<label for="itemVenda" class="form">
				Produto:
			</label>       	
	       	<html:select property="idProdutoItem">
				<html:option value=""></html:option>
	    		<html:optionsCollection name="produtosVenda" value="idProduto" label="descricaoTipoSubTipo"/>	
	    	</html:select>    	  	
		</div> 		
		
		<div class="div_bloco_2">
			<label for="metragem" class="form">
				Metragem:
			</label> 	
			<html:text property="metragem" size="15" maxlength="15" onkeypress="reaisLimitado(this,event,15,4)" onkeydown="backspace(this,event,4)"/>  	
		</div>
	</fieldset>
	
		<div class="botoes">
	        <input type="button" onclick="adicionarItem()" value="<bean:message key='btn.adicionarItem'/>" />        
	    </div>	
	
	</div>
 <%} %>
 
<logic:present name="listaItensVenda">
<fieldset class="fieldset">
<legend>Itens da Venda:</legend>
<display:table cellspacing="3" cellpadding="0" 
				name="listaItensVenda" pagesize="100" 
				id="item" class="tableResultadoConsulta" decorator="org.displaytag.decorator.TotalTableDecorator" varTotals="totals">
  <display:column property="descricao" title="Descrição" />
  <display:column property="preco" title="Valor(R$)" decorator="br.com.granit.util.decoradores.MoedaDecorator"/>
  <display:column property="produto.descricaoTipoSubTipo" title="Produto" />
  <display:column property="metragemFormatada" title="Metragem" />
  <%if (!venda.isProdutosEntregues()) { %>	
	  <display:column title="Remover">
	  		<html:link href="#" onclick="removerItem(${item.posicao})"><font color="#004080"><u>Remover</u></font></html:link>
	  </display:column>
  <%}%>
</display:table>
</fieldset>
</logic:present>

<%if (!venda.isProdutosEntregues()) { %>
	<a name="secaoItensBeneficiamento"><br/></a>
	<div id="secaoItensBeneficiamentoMessage" align="left"></div>
	<fieldset>
	<legend>Defina os itens de beneficiamento.</legend>
		<div class="div_bloco">
			<label for="itemVenda" class="form">
				Descrição do item:
			</label>       	
	       	<html:text property="descricaoItemBeneficiamento" size="50" style="TEXT-TRANSFORM: uppercase;"/>    	  	
		</div> 		
		<div class="div_bloco">
			<label for="quantidade" class="form">
				Valor do Item (R$):
			</label> 	
			<html:text property="valorItemBeneficiamento" onfocus="limpaCampo(this)"
					 size="15" maxlength="15" onkeypress="reaisLimitado(this,event,15)" onkeydown="backspace(this,event)"/>  	
		</div>
			
	</fieldset>
		<div class="botoes">
	        <input type="button" onclick="adicionarItemBeneficiamentoAlterar()" value="<bean:message key='btn.adicionarItem'/>" />        
	    </div>	
<%} 
 %>


<logic:present name="listaItensVendaBeneficiamento">
<fieldset class="fieldset">
<legend>Itens de Beneficiamento da Venda:</legend>
<display:table cellspacing="3" cellpadding="0" 
				name="listaItensVendaBeneficiamento" pagesize="100" 
				id="item" class="tableResultadoConsulta" decorator="org.displaytag.decorator.TotalTableDecorator" varTotals="totals">
  <display:column property="descricao" title="Descrição" />
  <display:column property="valor" title="Valor(R$)" decorator="br.com.granit.util.decoradores.MoedaDecorator"/>
  <%if (!venda.isProdutosEntregues()) { %> 
	  <display:column title="Remover">
	  		<html:link href="#" onclick="removerItemBeneficiamentoAlterar(${item.posicao})"><font color="#004080"><u>Remover</u></font></html:link>
	  </display:column>
  <%
  	}
  %>
</display:table>
<br>
</fieldset>
</logic:present>

<a name="secaoServicoMontagem"><br/></a>
<div id="secaoServicoMontagemMessage" align="left"></div>
<fieldset>
<legend>Serviço de Montagem:</legend>
<div class="div_bloco">
		<label for="valorServicoMontagemVenda" class="form">
			Valor do serviço(R$):
		</label>
<%if (venda.isProdutosEntregues()) { %>
		<html:text property="valorServicoMontagem" size="15" maxlength="15" readonly="true" disabled="true"/> 
<%}else{ %>
		<html:text onblur="atualizaTotalAPagarServicoMontagemAlterar()" property="valorServicoMontagem" onfocus="limpaCampo(this)"
				 size="15" maxlength="15" onkeypress="reaisLimitado(this,event,15)" onkeydown="backspace(this,event)"/> 
 <%} %>
	</div>	
</fieldset>	

<a name="secaoTotalizacao"><br/></a>
<div id="secaoTotalizacaoMessage" align="left"></div>
<fieldset>

<legend>Totalização da Venda:</legend>
<br>

	<div class="div_bloco">
		<label for="nome" class="form"><bean:message key="label.subtotal.venda"/></label>
       	<bean:write name="vendaCliente" property="subTotalFormatado"/>
       	<%if (!venda.isProdutosEntregues()) { %>
       		<html:button property="aplicarDesconto" onclick="aplicaDesconto(5)">Aplicar desconto</html:button>
       	<%}%>		
	</div>

	<div class="div_bloco">
		<label for="desconto" class="form">DESCONTO:</label>
		<%if (venda.isProdutosEntregues()) { %>
       		<html:text property="desconto"  size="10" maxlength="4" readonly="true" disabled="true"/>
	     <%}else {%>
	     	<html:text property="desconto" onblur="atualizaTotalAPagar()" onkeypress="reaisLimitado(this,event,15)"
	        	 onkeydown="backspace(this,event)" size="10" maxlength="4"/>
	     <%}%>
	     <bean:write name="vendaCliente" property="percentualDescontoFormatado"/>
	</div>
			   
	<div class="div_bloco">
		<label for="total" class="form">TOTAL:</label>
       	<bean:write name="vendaCliente" property="totalFormatado"/>		
	</div>  

</fieldset>

<fieldset>
<legend>Forma(s) de Pagamento:</legend>
	<br>
	<div class="div_bloco_1">
		<label for="valor" class="form">
			À Vista:
		</label> 
		<%if (venda.isProdutosEntregues()) { %>
			<html:text property="valorVista" size="15" maxlength="15" readonly="true" disabled="true" />
  		<%}else {%>
  			<html:text property="valorVista" size="15" maxlength="15"
		        	 onkeypress="reaisLimitado(this,event,15)"
		        	 onkeydown="backspace(this,event)"/>
  		<%}%>
	</div>
	<br>
	<div class="div_bloco_1">
		<label for="valor" class="form">
			Cheque:
		</label>
		<%if (venda.isProdutosEntregues()) { %>
 			<html:text property="valorCheque" size="15" maxlength="15" readonly="true" disabled="true"/>
  		<%}else {%>
  			<html:text property="valorCheque" size="15" maxlength="15"
	        	 onkeypress="reaisLimitado(this,event,15)"
	        	 onkeydown="backspace(this,event)"/>
  		<%}%>
	</div>
	<br>
	<div class="div_bloco_1">
		<label for="valor" class="form">
			Cartão de Crédito:
		</label>
 		<%if (venda.isProdutosEntregues()) { %>
			<html:text property="valorCredito" size="15" maxlength="15" readonly="true" disabled="true"/>
  		<%}else {%>
  			<html:text property="valorCredito" size="15" maxlength="15"
	        	 onkeypress="reaisLimitado(this,event,15)"
	        	 onkeydown="backspace(this,event)"/>
  		<%}%>
	</div>
	<br>
	<div class="div_bloco_1">
		<label for="valor" class="form">
			Boleto:
		</label>
 		<%if (venda.isProdutosEntregues()) { %>
			<html:text property="valorBoleto" size="15" maxlength="15" readonly="true" disabled="true"/>
  		<%}else {%>
  			<html:text property="valorBoleto" size="15" maxlength="15"
	        	 onkeypress="reaisLimitado(this,event,15)"
	        	 onkeydown="backspace(this,event)"/>
	     <%}%>
	</div>
	<br>
	<div class="div_bloco_1">
		<label for="valor" class="form">
			Em Aberto:
		</label> 
		<%if (venda.isProdutosEntregues()) { %>	
			<html:text property="valorAberto" size="15" maxlength="15" readonly="true" disabled="true"/>
  		<%}else {%>
  			<html:text property="valorAberto" size="15" maxlength="15"
	        	 onkeypress="reaisLimitado(this,event,15)"
	        	 onkeydown="backspace(this,event)"/>
  		<%}%>
	</div>	
	<div class="div_bloco_2">
  		<label for="parcela" class="form">
			Nº de Parcelas:
		</label>
		<%if (venda.isProdutosEntregues()) { %>	
			<html:text property="numeroParcelas" size="10" maxlength="3" readonly="true" disabled="true"/>
		<%}else {%>
			<html:text property="numeroParcelas" size="10" onfocus="limpaCampo(this)" maxlength="3" onkeypress="mascara(this,'999');"/>
		<%}%>
	</div>
	<br><br>
	<div class="div_bloco_2">
		<label for="observacao" class="form">
			Observação:
		</label>       	
       	<html:textarea property="observacao" cols="80" rows="10"/>    	  	
	</div> 		
	<br><br>
	<div class="div_bloco_1">
		<label for="entregue" class="form">
			Produtos/Serviços entregues:
		</label>
		<%if (venda.isProdutosEntregues()) { //Só edita se ainda não tiver confirmado a entrega %>	
       		<html:checkbox property="entregue" disabled="true"/>
       	<%}else {%>
       	 	<html:checkbox property="entregue" onclick="produtoEntregue()"/>
       	<%}%>  	  	
	</div> 	
</fieldset>

<div class="botoes">
	<input type="button" onclick="alterar()" value="<bean:message key='btn.atualizar'/>" />
    <input type="button" onclick="cancelar()" value="<bean:message key='btn.cancelar'/>" />
	<input type="button" onclick="finalizar()" value="<bean:message key='btn.finalizar'/>" />
</div>	
</html:form>
<script>
	goToAnchor();
</script>